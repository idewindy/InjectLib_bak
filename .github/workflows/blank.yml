name: Sync All Releases from Upstream

on:
  schedule:
    # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡
    - cron: '0 8 20 * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Sync all releases
      run: |
        # è®¾ç½®ä»“åº“ä¿¡æ¯
        UPSTREAM_REPO="LanYunDev/InjectLib_bak"
        FORK_REPO="$GITHUB_REPOSITORY"
        
        echo "æ­£åœ¨åŒæ­¥æ‰€æœ‰releases: $UPSTREAM_REPO åˆ° $FORK_REPO"
        
        # æ·»åŠ upstreamå¹¶è·å–tags
        git remote add upstream https://github.com/$UPSTREAM_REPO.git || true
        git fetch upstream --tags
        git push origin --tags
        
        # è·å–æ‰€æœ‰releaseæ ‡ç­¾ (æœ€å¤š100ä¸ª)
        echo "è·å–æ‰€æœ‰releases..."
        ALL_RELEASES=$(gh release list --repo $UPSTREAM_REPO --limit 100 --json tagName,name,isDraft,isPrerelease)
        
        if [ "$ALL_RELEASES" = "[]" ]; then
          echo "æ²¡æœ‰æ‰¾åˆ°releases"
          exit 0
        fi
        
        RELEASE_COUNT=$(echo "$ALL_RELEASES" | jq '. | length')
        echo "æ‰¾åˆ° $RELEASE_COUNT ä¸ªreleases"
        
        # è®¡æ•°å™¨
        SUCCESS_COUNT=0
        SKIP_COUNT=0
        ERROR_COUNT=0
        
        # å¤„ç†æ¯ä¸ªrelease
        echo "$ALL_RELEASES" | jq -c '.[]' | while read -r release; do
          TAG_NAME=$(echo "$release" | jq -r '.tagName')
          RELEASE_NAME=$(echo "$release" | jq -r '.name')
          IS_DRAFT=$(echo "$release" | jq -r '.isDraft')
          IS_PRERELEASE=$(echo "$release" | jq -r '.isPrerelease')
          
          echo ""
          echo "å¤„ç† release: $TAG_NAME - $RELEASE_NAME"
          
          # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
          if gh release view "$TAG_NAME" --repo $FORK_REPO >/dev/null 2>&1; then
            echo "  â­ï¸ å·²å­˜åœ¨ï¼Œè·³è¿‡"
            continue
          fi
          
          # è·å–è¯¦ç»†çš„releaseä¿¡æ¯ï¼ˆåŒ…å«bodyï¼‰
          echo "  ğŸ“ è·å–releaseè¯¦æƒ…..."
          RELEASE_BODY=$(gh release view "$TAG_NAME" --repo $UPSTREAM_REPO --json body --jq '.body // ""')
          
          # åˆ›å»ºåŒæ­¥è¯´æ˜
          echo "ğŸ”„ **Auto-synced from upstream repository**" > "/tmp/sync_${TAG_NAME//\//_}.txt"
          echo "" >> "/tmp/sync_${TAG_NAME//\//_}.txt"
          echo "$RELEASE_BODY" >> "/tmp/sync_${TAG_NAME//\//_}.txt"
          
          # æ„å»ºåˆ›å»ºå‘½ä»¤
          CREATE_CMD='gh release create "'$TAG_NAME'" --repo "'$FORK_REPO'" --title "'$RELEASE_NAME'" --notes-file "/tmp/sync_'${TAG_NAME//\//_}'.txt"'
          
          # æ·»åŠ flags
          if [ "$IS_DRAFT" = "true" ]; then
            CREATE_CMD="$CREATE_CMD --draft"
          fi
          
          if [ "$IS_PRERELEASE" = "true" ]; then
            CREATE_CMD="$CREATE_CMD --prerelease"
          fi
          
          echo "  ğŸ†• åˆ›å»ºrelease..."
          if eval "$CREATE_CMD"; then
            echo "  âœ… Releaseåˆ›å»ºæˆåŠŸ"
            
            # å¤„ç†assets
            echo "  ğŸ“¥ æ£€æŸ¥assets..."
            TEMP_DIR="/tmp/assets_${TAG_NAME//\//_}"
            mkdir -p "$TEMP_DIR"
            cd "$TEMP_DIR"
            
            if gh release download "$TAG_NAME" --repo $UPSTREAM_REPO 2>/dev/null; then
              if ls ./* >/dev/null 2>&1; then
                echo "  ğŸ“¤ ä¸Šä¼ assets..."
                if gh release upload "$TAG_NAME" ./* --repo $FORK_REPO; then
                  echo "  âœ… Assetsä¸Šä¼ æˆåŠŸ"
                else
                  echo "  âš ï¸ Assetsä¸Šä¼ å¤±è´¥"
                fi
              else
                echo "  â„¹ï¸ æ²¡æœ‰assets"
              fi
            else
              echo "  â„¹ï¸ æ²¡æœ‰assetså¯ä¸‹è½½"
            fi
            
            # æ¸…ç†ä¸´æ—¶ç›®å½•
            cd /
            rm -rf "$TEMP_DIR"
            
          else
            echo "  âŒ Releaseåˆ›å»ºå¤±è´¥"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "/tmp/sync_${TAG_NAME//\//_}.txt"
          
          # æ·»åŠ å»¶è¿Ÿé¿å…APIé™åˆ¶
          sleep 2
        done
        
        echo ""
        echo "========================================"
        echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
        echo "æŸ¥çœ‹releases: https://github.com/$FORK_REPO/releases"
        
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
