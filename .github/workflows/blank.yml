name: Sync Releases from Upstream (Simple Version)

on:
  schedule:
    # æ¯å¤©æ£€æŸ¥ä¸€æ¬¡
    - cron: '0 8 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-releases:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Sync releases
      run: |
        # è®¾ç½®ä»“åº“ä¿¡æ¯
        UPSTREAM_REPO="LanYunDev/InjectLib_bak"
        FORK_REPO="$GITHUB_REPOSITORY"
        
        echo "æ­£åœ¨åŒæ­¥ $UPSTREAM_REPO åˆ° $FORK_REPO"
        
        # æ·»åŠ upstreamå¹¶è·å–tags
        git remote add upstream https://github.com/$UPSTREAM_REPO.git
        git fetch upstream --tags
        git push origin --tags
        
        # è·å–æœ€æ–°releaseä¿¡æ¯
        LATEST_TAG=$(gh release list --repo $UPSTREAM_REPO --limit 1 --json tagName --jq '.[0].tagName')
        
        if [ "$LATEST_TAG" = "null" ] || [ -z "$LATEST_TAG" ]; then
          echo "æ²¡æœ‰æ‰¾åˆ°releases"
          exit 0
        fi
        
        echo "æœ€æ–°release: $LATEST_TAG"
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if gh release view "$LATEST_TAG" --repo $FORK_REPO >/dev/null 2>&1; then
          echo "Release $LATEST_TAG å·²å­˜åœ¨"
          exit 0
        fi
        
        # è·å–releaseè¯¦ç»†ä¿¡æ¯
        RELEASE_INFO=$(gh release view "$LATEST_TAG" --repo $UPSTREAM_REPO --json name,body,isDraft,isPrerelease)
        RELEASE_NAME=$(echo "$RELEASE_INFO" | jq -r '.name')
        IS_DRAFT=$(echo "$RELEASE_INFO" | jq -r '.isDraft')
        IS_PRERELEASE=$(echo "$RELEASE_INFO" | jq -r '.isPrerelease')
        
        # ä¿å­˜bodyåˆ°æ–‡ä»¶ä»¥é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
        echo "$RELEASE_INFO" | jq -r '.body' > /tmp/release_body.txt
        
        # æ„å»ºåˆ›å»ºå‘½ä»¤
        CREATE_CMD="gh release create '$LATEST_TAG' --repo '$FORK_REPO' --title '$RELEASE_NAME'"
        
        # æ·»åŠ notes
        echo "ğŸ”„ **Auto-synced from upstream repository**" > /tmp/sync_body.txt
        echo "" >> /tmp/sync_body.txt
        cat /tmp/release_body.txt >> /tmp/sync_body.txt
        CREATE_CMD="$CREATE_CMD --notes-file /tmp/sync_body.txt"
        
        # æ·»åŠ flags
        if [ "$IS_DRAFT" = "true" ]; then
          CREATE_CMD="$CREATE_CMD --draft"
        fi
        
        if [ "$IS_PRERELEASE" = "true" ]; then
          CREATE_CMD="$CREATE_CMD --prerelease"
        fi
        
        echo "åˆ›å»ºrelease: $LATEST_TAG"
        eval $CREATE_CMD
        
        # ä¸‹è½½å¹¶ä¸Šä¼ assets
        echo "å¤„ç†assets..."
        mkdir -p /tmp/assets
        cd /tmp/assets
        
        if gh release download "$LATEST_TAG" --repo $UPSTREAM_REPO 2>/dev/null; then
          if ls ./* >/dev/null 2>&1; then
            echo "ä¸Šä¼ assets..."
            gh release upload "$LATEST_TAG" ./* --repo $FORK_REPO
            echo "Assetsä¸Šä¼ å®Œæˆ"
          else
            echo "æ²¡æœ‰assetséœ€è¦ä¸Šä¼ "
          fi
        else
          echo "æ²¡æœ‰assetså¯ä¸‹è½½"
        fi
        
        echo "åŒæ­¥å®Œæˆ: $LATEST_TAG"
        
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
